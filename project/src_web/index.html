<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="styles.css" rel="stylesheet" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><rect width='100%' height='100%' fill='red'/></svg>"
    />
    <script type="module">
      import Alpine from 'alpinejs';
      import persist from '@alpinejs/persist';
      import focus from '@alpinejs/focus';
      import { sha256 } from './crypto.js';
      import { getDeviceNameHelper, openMultiFilePicker } from './helpers.js';
      import { userLogin, userRegister, userLogout } from './user.js';

      const API_ENDPOINT = ['http://localhost:8787/api'];
      const MAX_RETRIES = 3;

      const workerCount = navigator.hardwareConcurrency > 2 ? 2 : 1 || 1;
      const workers = Array.from({ length: workerCount }, () => new Worker('public/worker.js'));
      const chunkSize = 8 * 1024 * 1024;

      const draggingSomething = event => {
        console.log('Dragging something:', event);
      };

      Alpine.plugin(persist);
      Alpine.plugin(focus);
      Alpine.store('account', {
        username: Alpine.$persist('').as('username'),
        sha256email: Alpine.$persist('').as('sha256email'),
        devicename: Alpine.$persist(getDeviceNameHelper()).as('devicename'),
        isLoggedIn: Alpine.$persist(false).as('isLoggedIn'),
        draggingListener: false,
        dragActive: false,
        emailNotifications: true,
        cwd: null,
        cwdId: null,
        init() {
          if (this.loggedIn && this.username) {
            console.log('User is logged in as', this.username, 'on device:', this.devicename);
            this.cwd = '/';
            // check if dragging listeners exists
            if (!this.draggingListener) {
              this.draggingListener = true;
              document.addEventListener('dragstart', draggingSomething, false);
            }
          }
        },
        async createNew(newUsername) {
          console.log('Creating new user:', newUsername);
          const username = newUsername.trim();
          const sha256email = await sha256(username, 'hex');
          const registerResp = await userRegister(sha256email, this.devicename, username, API_ENDPOINT);
          if (registerResp.ok) {
            await this.login(username);
          } else {
            alert(registerResp.message);
          }
        },
        async login(username) {
          console.log('Logging in user:', username);
          this.username = username.trim();
          this.sha256email = await sha256(this.username, 'hex');
          const loginResp = await userLogin(this.sha256email, this.devicename, this.username, API_ENDPOINT);
          console.log('login response is: ', loginResp);
          if (loginResp.ok) {
            this.isLoggedIn = true;
          } else {
            this.isLoggedIn = false;
            alert(loginResp.message);
          }
        },
        async logout() {
          this.username = '';
          await userLogout(this.sha256email, API_ENDPOINT);
          this.sha256email = '';
          this.isLoggedIn = false;
          if (this.draggingListener) {
            document.removeEventListener('dragstart', draggingSomething, false);
            this.draggingListener = false;
          }
        },
        addNewDir() {
          const dirName = prompt('Enter new directory name:');
          if (dirName && dirName.trim() !== '') {
            alert(`New directory "${dirName.trim()}" created (not really, this is a demo).`);
          }
        },
        async openPicker() {
          if (window.showDirectoryPicker) {
            // --- Modern API: Directory Picker ---
            try {
              const dirHandle = await window.showDirectoryPicker();

              async function processDirectory(dirHandle, parentId = null) {
                console.warn('Processing directory:', dirHandle.name);
                // const dirId = generateUUID();
                // const entry = createEntry(dirId, parentId, dirHandle.name, 0, 'directory');
                // ymap1.set(dirId, entry);

                // for await (const handle of dirHandle.values()) {
                //   if (handle.kind === 'file') {
                //     const file = await handle.getFile();
                //     const fileId = generateUUID();
                //     const fileEntry = createEntry(fileId, dirId, handle.name, file.size, 'file');
                //     ymap1.set(fileId, fileEntry);
                //   } else if (handle.kind === 'directory') {
                //     await processDirectory(handle, dirId);
                //   }
                // }
              }

              await processDirectory(dirHandle, null);
              console.log('Files loaded (directory mode):', ymap1.size, generateJSONTree(ymap1));
            } catch (err) {
              console.error('Directory selection cancelled or error:', err);
            }
          } else {
            // --- Fallback: Multi-file picker ---
            openMultiFilePicker(files => {
              try {
                console.warn('files are: ', files);
                // const rootId = generateUUID();
                // const rootEntry = createEntry(rootId, null, 'Selected Files', 0, 'directory');
                // ymap1.set(rootId, rootEntry);

                // for (let file of files) {
                //   const fileId = generateUUID();
                //   const fileEntry = createEntry(fileId, rootId, file.name, file.size, 'file');
                //   ymap1.set(fileId, fileEntry);
                // }

                // console.log('Files loaded (multi-file mode):', ymap1.size, generateJSONTree(ymap1));
              } catch (err) {
                console.error('Multi-file selection error:', err);
              }
            });
          }
        },
      });
      Alpine.start();
    </script>
  </head>
  <body>
    <div x-data>
      <dialog
        x-init="console.log($store.account.username)"
        id="my_modal_1"
        class="modal"
        :class="{ 'modal-open': !$store.account.isLoggedIn }"
      >
        <div class="modal-box">
          <div role="alert" class="alert alert-warning mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 shrink-0 stroke-current"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
            <span>Warning: This is DEMO ONLY - do not use for production!</span>
          </div>
          <h3 class="text-lg font-bold">Let's get in!</h3>
          <!-- <p class="py-4">Document bitte</p> -->
          <div class="w-full">
            <form method="dialog" x-data="{ newUsername: '' }" x-on:submit="event.preventDefault();">
              <fieldset class="fieldset w-full">
                <legend class="fieldset-legend w-full">Fill in your email</legend>
                <input type="email" class="input w-full" placeholder="eg. tim@apple.com" x-model="newUsername" />
                <!-- <label class="label">
                  <input type="checkbox" checked="checked" class="checkbox" />
                  Your email will only be used to notify you of important service changes. We do not share or sell your
                  data. Unsubscribe anytime.
                </label> -->
                <div class="flex items-start pt-4">
                  <input
                    type="checkbox"
                    checked="checked"
                    class="checkbox"
                    :checked="$store.account.emailNotifications"
                  />
                  <span
                    class="text-sm px-3"
                    @click="$store.account.emailNotifications = !$store.account.emailNotifications"
                  >
                    Your email will only be used to notify you of important service changes. We keep it very safe.
                    Unsubscribe anytime.
                  </span>
                </div>
              </fieldset>
              <button
                class="btn mt-5"
                @click="await $store.account.login(newUsername.trim())"
                :disabled="newUsername.trim().length === 0 || !$store.account.emailNotifications"
              >
                Login
              </button>
              <button
                class="btn mt-5"
                @click="await $store.account.createNew(newUsername.trim())"
                :disabled="newUsername.trim().length === 0 || !$store.account.emailNotifications"
              >
                Registration
              </button>
            </form>
          </div>
        </div>
      </dialog>

      <div x-show="$store.account.isLoggedIn" class="drawer mx-auto max-w-[100rem] md:drawer-open bg-base-300">
        <input id="my-drawer" type="checkbox" class="drawer-toggle" />
        <div
          class="drawer-content bg-base-300"
          x-data="{
	          files: [],
	          dragActive: $store.account.dragActive,
	        }"
        >
          <div role="alert" class="alert alert-warning">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 shrink-0 stroke-current"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
            <span>Warning: This is DEMO ONLY - do not use for production!</span>
          </div>
          <header class="navbar transparent sticky top-0 z-30 flex h-16 w-full duration-100">
            <div class="flex-1">
              <ul class="menu menu-horizontal p-0 w-full">
                <!-- <label for="my-drawer" class="btn btn-primary drawer-button md:hidden">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    class="inline-block h-5 w-5 stroke-current"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"
                    ></path>
                  </svg>
                </label> -->
                <li class="w-full">
                  <label class="input input-ghost w-full">
                    <svg class="h-[1em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                      <g
                        stroke-linejoin="round"
                        stroke-linecap="round"
                        stroke-width="2.5"
                        fill="none"
                        stroke="currentColor"
                      >
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                      </g>
                    </svg>
                    <input
                      type="search"
                      placeholder="Quick search"
                      autocomplete="off"
                      spellcheck="false"
                      aria-autocomplete="list"
                      class="w-full"
                    />
                  </label>
                </li>
              </ul>
            </div>
            <div class="flex-none">
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                  <div class="w-10 rounded-full">
                    <img
                      alt="Profile Picture"
                      src="https://gravatar.com/avatar/{{ $store.account.sha256email }}?s=200&d=retro"
                    />
                  </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content bg-base-100 rounded-box z-1 mt-3 w-52 p-2 shadow">
                  <li>
                    <a class="nowrap">
                      Account (<span class="inline" x-text="$store.account.username.trim()"></span>)
                      <!-- <span class="badge">New</span> -->
                    </a>
                  </li>
                  <!-- <li><a>Settings</a></li> -->
                  <li><a @click="await $store.account.logout()">Logout</a></li>
                </ul>
              </div>
            </div>
          </header>
          <div class="relative max-w-[100vw] px-6 pb-16 xl:pe-2">
            <!-- content goes here -->
            <div class="breadcrumbs text-sm" style="overflow-x: visible">
              <ul>
                <li>
                  <a>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      class="h-4 w-4 stroke-current"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                      ></path>
                    </svg>
                    /
                  </a>
                </li>
                <!-- <li>
                <a>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    class="h-4 w-4 stroke-current"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                    ></path>
                  </svg>
                  Photos
                </a>
              </li> -->
                <li class="dropdown" accesskey="a" aria-label="+ Add entry" role="menu">
                  <div
                    tabindex="0"
                    role="button"
                    class="inline-block items-center gap-2 btn m-1 no-underline hover:no-underline"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      class="h-4 w-4 stroke-current"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      ></path>
                    </svg>
                    Add
                  </div>
                  <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm">
                    <li class="w-full">
                      <button aria-label="New directory" accesskey="n" @click="$store.account.addNewDir()">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          class="h-4 w-4 stroke-current"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                          ></path>
                        </svg>
                        New directory
                      </button>
                    </li>
                    <li class="w-full" x-show="!!window.showDirectoryPicker">
                      <button accesskey="u" aria-label="Upload directory" @click="$store.account.openPicker()">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          class="h-4 w-4 stroke-current"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                          ></path>
                        </svg>
                        Upload directory
                      </button>
                    </li>
                    <li class="w-full">
                      <button accesskey="u" aria-label="Upload files" @click="$store.account.openPicker()">
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="h-4 w-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"
                          />
                        </svg>
                        Upload files
                      </button>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
            <div id="content">
              <ul class="list">
                <!-- <li
                    class="list-row bg-base-200 shadow-sm"
                    x-show="$store.dashboard.addNewDir"
                    x-trap="$store.dashboard.addNewDir"
                  >
                    <div>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        class="stroke-current size-8 rounded-box"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.28"
                          d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                        ></path>
                      </svg>
                    </div>
                    <div>
                      <form @submit.prevent="$store.dashboard.createNewDirectory()">
                        <div>
                          <input
                            type="text"
                            placeholder="New directory name"
                            x-model="$store.dashboard.newDirName"
                            @keydown.esc="$store.dashboard.addNewDir = false"
                          />
                        </div>
                      </form>
                    </div>
                    <button
                      class="btn btn-ghost"
                      :class="$store.dashboard.newDirName !== '' ? 'border-success' : ''"
                      :disabled="$store.dashboard.newDirName === ''"
                    >
                      <kbd class="kbd kbd-sm">⏎</kbd>
                      <span>Confirm</span>
                    </button>
                    <button class="btn btn-ghost text-error"><kbd class="kbd kbd-sm">esc</kbd> Discard</button>
                  </li> -->
                <!-- <template x-for="file in $store.dashboard.files" :key="file.keyId">
                    <li class="list-row hover:bg-base-200 hover:shadow-sm cursor-pointer">
                      <div>
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          class="stroke-current size-8 rounded-box"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="1.28"
                            d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"
                          ></path>
                        </svg>
                      </div>
                      <div>
                        <div><span x-text="file.name"></span></div>
                        <div class="text-xs uppercase font-semibold opacity-60">...</div>
                      </div>
                      <button class="btn btn-square btn-ghost">
                        <svg class="size-[1.2em]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <g
                            stroke-linejoin="round"
                            stroke-linecap="round"
                            stroke-width="2"
                            fill="none"
                            stroke="currentColor"
                          >
                            <path d="M6 3L20 12 6 21 6 3z"></path>
                          </g>
                        </svg>
                      </button>
                      <button class="btn btn-square btn-ghost">
                        <svg class="size-[1.2em]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                          <g
                            stroke-linejoin="round"
                            stroke-linecap="round"
                            stroke-width="2"
                            fill="none"
                            stroke="currentColor"
                          >
                            <path
                              d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
                            ></path>
                          </g>
                        </svg>
                      </button>
                    </li>
                  </template> -->
              </ul>
            </div>
          </div>
        </div>
        <div class="drawer-side z-40" x-side></div>
      </div>
    </div>
  </body>
</html>
